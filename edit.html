<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Edit Wall</title>
    <style>
        body {
            margin: 0;
            background: black;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";

        }

        p,
        ul,
        li {
            color: white;
        }

        .container {
            margin: auto;
            margin-top: 3em;
            display: block;
            max-width: 900px;
        }

        textarea {
            width: 100%;
            height: 300px;
        }

        .pace {
            -webkit-pointer-events: none;
            pointer-events: none;

            -webkit-user-select: none;
            -moz-user-select: none;
            user-select: none;

            z-index: 2000;
            position: fixed;
            margin: auto;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            height: 5px;
            width: 200px;
            background: #fff;
            border: 1px solid RGB(248, 168, 57);

            overflow: hidden;
        }

        .pace .pace-progress {
            -webkit-box-sizing: border-box;
            -moz-box-sizing: border-box;
            -ms-box-sizing: border-box;
            -o-box-sizing: border-box;
            box-sizing: border-box;

            -webkit-transform: translate3d(0, 0, 0);
            -moz-transform: translate3d(0, 0, 0);
            -ms-transform: translate3d(0, 0, 0);
            -o-transform: translate3d(0, 0, 0);
            transform: translate3d(0, 0, 0);

            max-width: 200px;
            position: fixed;
            z-index: 2000;
            display: block;
            position: absolute;
            top: 0;
            right: 100%;
            height: 100%;
            width: 100%;
            background: RGB(248, 168, 57);
        }

        .pace.pace-inactive {
            display: none;
        }

        button {
            -moz-box-shadow: inset 0px 1px 0px 0px #ffffff;
            -webkit-box-shadow: inset 0px 1px 0px 0px #ffffff;
            box-shadow: inset 0px 1px 0px 0px #ffffff;
            background: -webkit-gradient(linear, left top, left bottom, color-stop(0.05, #ffffff), color-stop(1, #f6f6f6));
            background: -moz-linear-gradient(top, #ffffff 5%, #f6f6f6 100%);
            background: -webkit-linear-gradient(top, #ffffff 5%, #f6f6f6 100%);
            background: -o-linear-gradient(top, #ffffff 5%, #f6f6f6 100%);
            background: -ms-linear-gradient(top, #ffffff 5%, #f6f6f6 100%);
            background: linear-gradient(to bottom, #ffffff 5%, #f6f6f6 100%);
            filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#ffffff', endColorstr='#f6f6f6', GradientType=0);
            background-color: #ffffff;
            -moz-border-radius: 6px;
            -webkit-border-radius: 6px;
            border-radius: 6px;
            border: 1px solid #dcdcdc;
            display: inline-block;
            cursor: pointer;
            color: #666666;
            font-size: 15px;
            font-weight: bold;
            padding: 6px 24px;
            text-decoration: none;
            text-shadow: 0px 1px 0px #ffffff;
        }

        button:hover {
            background: -webkit-gradient(linear, left top, left bottom, color-stop(0.05, #f6f6f6), color-stop(1, #ffffff));
            background: -moz-linear-gradient(top, #f6f6f6 5%, #ffffff 100%);
            background: -webkit-linear-gradient(top, #f6f6f6 5%, #ffffff 100%);
            background: -o-linear-gradient(top, #f6f6f6 5%, #ffffff 100%);
            background: -ms-linear-gradient(top, #f6f6f6 5%, #ffffff 100%);
            background: linear-gradient(to bottom, #f6f6f6 5%, #ffffff 100%);
            filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#f6f6f6', endColorstr='#ffffff', GradientType=0);
            background-color: #f6f6f6;
        }

        button:active {
            position: relative;
            top: 1px;
        }
    </style>
</head>

<body>


    <div class="container">
        <p>Paste in iTunes URLs (one per line) to add them to the Wall</p>
        <textarea id="textArea"></textarea>
        <button onclick="getAppsFromTextArea();">Add</button>
        <p><strong>Current Apps:</strong></p>
        <ul id="current"></ul>
        <button onclick="clearList();">Clear List</button>

        <p><strong>Top Apps:</strong></p>
        <ul id="topapps"></ul>
    </div>


    <script src="/pace.min.js"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js'></script>
    <script>
        function getAppsFromTextArea() {
            var lines = $("#textArea").val().split('\n');
            for (var i = 0; i < lines.length; i++) {
                //https://itunes.apple.com/au/app/atlas-wallpaper/id1368484008?mt=8
                var parts = lines[i].split('id');
                var id = parts[1].split('?')[0];
                console.log("id", id);

                var country = lines[i].split('itunes.apple.com/');
                country = country[1].split('/app');
                if (country[0] && country[0].length === 2) {
                    getAppWithId(id, country[0]);
                } else {
                    getAppWithId(id, "US");
                }

                
            }
        }
        function getAppWithId(appID, country) {
            $.getJSON("https://itunes.apple.com/lookup?callback=?&id=" + appID + "&country=" + country, function (response) {
                //response data are now in the result variable

                var apps = response.results;
                saveApps([apps[0]]);
            });
        }
        function saveApps(array) {
            var old = JSON.parse(localStorage.getItem("apps"));
            if (old === null) old = [];
            var newData = old.concat(array);
            localStorage.setItem("apps", JSON.stringify(newData));
            getApps();
        }
        function getApps() {
            $("#current").empty();
            var localapps = JSON.parse(localStorage.getItem("apps"));
            if (localapps && localapps.length > 0) {
                localapps.forEach(app => {
                    var name = app.trackName;
                    var obj = '<li>' + name + '</li>'
                    $("#current").append(obj)
                });
            }

        }
        function clearList() {
            localStorage.removeItem("apps");
            getApps();
        }

        getApps();
        getTopApps();



        var freeApps;
        var paidApps;

        function getTopApps() {
            getFreeApps();
            getPaidApps();


        }

        function getPaidApps() {
            var settings = {
                "async": true,
                "url": "/paid-apps",
                "method": "GET",
            }
            $.ajax(settings).done(function (response) {
                console.log(response);

                paidApps = response.feed.results;

                setAppStore();
            });
        }

        function getFreeApps() {
            var settings = {
                "async": true,
                "url": "/free-apps",
                "method": "GET",
            }
            $.ajax(settings).done(function (response) {
                console.log(response);

                freeApps = response.feed.results;

                setAppStore();
            });
        }

        function setAppStore() {
            console.log("freeApps", freeApps);
            console.log("paidApps", paidApps);
            if (freeApps && paidApps) {
                console.log("combine");
                var arrayCombined = $.map(freeApps, function (v, i) {
                    return [v, paidApps[i]];
                });
                console.log(arrayCombined);
                setTopApps(arrayCombined);
            }
        }

        function setTopApps(array) {
            array.forEach(app => {
                var name = app.name;
                var obj = '<li><button onclick="getAppWithId(' + app.id + ', \'US\');">+</button>&nbsp;&nbsp;&nbsp;&nbsp;' + name + '</li>'
                $("#topapps").append(obj)
            });
        }

        
    </script>
</body>

</html>