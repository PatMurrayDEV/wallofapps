<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Edit Wall</title>
    <style>
        body {
            margin: 0;
            background: black;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";

        }

        p,
        ul,
        li {
            color: white;
        }

        .container {
            margin: auto;
            margin-top: 3em;
            display: block;
            max-width: 900px;
            padding: 1em;
        }

        textarea {
            width: 100%;
            max-width: 600px;
            height: 100px;
            margin: auto;
            margin-bottom: 1em;
        }

        .pace {
            -webkit-pointer-events: none;
            pointer-events: none;

            -webkit-user-select: none;
            -moz-user-select: none;
            user-select: none;

            z-index: 2000;
            position: fixed;
            margin: auto;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            height: 5px;
            width: 200px;
            background: #fff;
            border: 1px solid RGB(248, 168, 57);

            overflow: hidden;
        }

        .pace .pace-progress {
            -webkit-box-sizing: border-box;
            -moz-box-sizing: border-box;
            -ms-box-sizing: border-box;
            -o-box-sizing: border-box;
            box-sizing: border-box;

            -webkit-transform: translate3d(0, 0, 0);
            -moz-transform: translate3d(0, 0, 0);
            -ms-transform: translate3d(0, 0, 0);
            -o-transform: translate3d(0, 0, 0);
            transform: translate3d(0, 0, 0);

            max-width: 200px;
            position: fixed;
            z-index: 2000;
            display: block;
            position: absolute;
            top: 0;
            right: 100%;
            height: 100%;
            width: 100%;
            background: RGB(248, 168, 57);
        }

        .pace.pace-inactive {
            display: none;
        }

        button, .button {
      -moz-box-shadow: inset 0px 1px 0px 0px #ffffff;
      -webkit-box-shadow: inset 0px 1px 0px 0px #ffffff;
      box-shadow: inset 0px 1px 0px 0px #ffffff;
      background: -webkit-gradient(linear, left top, left bottom, color-stop(0.05, #ffffff), color-stop(1, #f6f6f6));
      background: -moz-linear-gradient(top, #ffffff 5%, #f6f6f6 100%);
      background: -webkit-linear-gradient(top, #ffffff 5%, #f6f6f6 100%);
      background: -o-linear-gradient(top, #ffffff 5%, #f6f6f6 100%);
      background: -ms-linear-gradient(top, #ffffff 5%, #f6f6f6 100%);
      background: linear-gradient(to bottom, #ffffff 5%, #f6f6f6 100%);
      filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#ffffff', endColorstr='#f6f6f6', GradientType=0);
      background-color: #ffffff;
      -moz-border-radius: 6px;
      -webkit-border-radius: 6px;
      border-radius: 6px;
      border: 1px solid #dcdcdc;
      display: inline-block;
      cursor: pointer;
      color: #666666;
      font-size: 15px;
      font-weight: bold;
      padding: 6px 24px;
      text-decoration: none;
      text-shadow: 0px 1px 0px #ffffff;
    }
        
        button.small, .button.small {
            display: block;
            padding: 0;
            margin-top: -38px;
            margin-left: 10px;
            position: relative;
            margin-bottom: 1.3em;
            border-color: black;
            width: 30px;
            height: 30px;
            border-radius: 50%;
        }

    button:hover, .button:hover  {
      background: -webkit-gradient(linear, left top, left bottom, color-stop(0.05, #f6f6f6), color-stop(1, #ffffff));
      background: -moz-linear-gradient(top, #f6f6f6 5%, #ffffff 100%);
      background: -webkit-linear-gradient(top, #f6f6f6 5%, #ffffff 100%);
      background: -o-linear-gradient(top, #f6f6f6 5%, #ffffff 100%);
      background: -ms-linear-gradient(top, #f6f6f6 5%, #ffffff 100%);
      background: linear-gradient(to bottom, #f6f6f6 5%, #ffffff 100%);
      filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#f6f6f6', endColorstr='#ffffff', GradientType=0);
      background-color: #f6f6f6;
      text-decoration: none;
    }

    button:active, .button:active {
      position: relative;
      top: 1px;
    }

        li {
            display: inline-block;
            font-size: 70%;
            width: 10%;
            min-width: 80px;
            vertical-align: top;
            margin-right: 10px;
            margin-bottom: 1em;
        }

        .icon {
            width: 100%;
            border-radius: 20%;
        }
        h1, h2, h3{
            color: white;
        }
    </style>
</head>

<body>


    <div class="container">
        <a class="button" href="/" style="float: right;margin: 21px;">Present Wall</a>

        <h1>Edit Wall of Apps</h1>

        <h2>Current Apps:</h2>
        <button onclick="clearList();">Clear List</button>
        <button onclick="shuffleApps();">Shuffle List</button>
        <a class="button" id="downloadLink" href="" download="wallofapps.json">Export</a>
        <button onclick="importList();">Import</button>
        <input id="file-input" type="file" name="name" style="display: none;" accept=".json" />
        <ul id="current"></ul>

        <hr>

        <h2>Add Apps:</h2>
        <h3>iTunes URL</h3>
        <p>Paste in iTunes URLs (one per line) to add them to the Wall</p>
        <textarea id="textArea"></textarea><br />
        <button onclick="getAppsFromTextArea();">Add</button>



        <h3>Top Apps</h3>
        <ul id="topapps"></ul>
    </div>


    <script src="/pace.min.js"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js'></script>
    <script>

        function exportList() {
            var localapps = JSON.parse(localStorage.getItem("apps"));
            var exportApps = new Array();
            if (localapps && localapps.length > 0) {
                localapps.forEach(app => {
                    var exportApp = {
                        'trackName': app.trackName,
                        'artworkUrl100': app.artworkUrl100,
                        'trackId' : app.trackId,
                        'trackViewUrl': app.trackViewUrl
                    };
                    exportApps.push(exportApp);
                });
            }
            var string = "data:text/json," + JSON.stringify(exportApps)
            $("#downloadLink").attr('href', string);
        }

        function importList() {
            $('#file-input').trigger('click');
        }

        $("#file-input").change(function () {
            var fileName = $(this).val();
            if (this.files && this.files[0]) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    console.log(e.target.result);
                    localStorage.apps = e.target.result;
                    getApps();
                }
                reader.readAsText(this.files[0]);
            }
        });

        function getAppsFromTextArea() {
            var lines = $("#textArea").val().split('\n');
            for (var i = 0; i < lines.length; i++) {
                //https://itunes.apple.com/au/app/atlas-wallpaper/id1368484008?mt=8
                var parts = lines[i].split('id');
                var id = parts[1].split('?')[0];
                console.log("id", id);

                var country = lines[i].split('itunes.apple.com/');
                country = country[1].split('/app');
                if (country[0] && country[0].length === 2) {
                    getAppWithId(id, country[0]);
                } else {
                    getAppWithId(id, "US");
                }


            }
        }

        function shuffleApps() {
            var old = JSON.parse(localStorage.getItem("apps"));
            if (old === null) old = [];
            var newData = shuffle(old);
            localStorage.setItem("apps", JSON.stringify(newData));
            getApps();
        }

        function shuffle(a) {
            var j, x, i;
            for (i = a.length - 1; i > 0; i--) {
                j = Math.floor(Math.random() * (i + 1));
                x = a[i];
                a[i] = a[j];
                a[j] = x;
            }
            return a;
        }

        function getAppWithId(appID, country) {
            $.getJSON("https://itunes.apple.com/lookup?callback=?&id=" + appID + "&country=" + country, function (
                response) {
                //response data are now in the result variable

                if (response.results.length > 0) {
                    var apps = response.results;
                    saveApps([apps[0]]);
                }

            });
        }

        function saveApps(array) {
            var old = JSON.parse(localStorage.getItem("apps"));
            if (old === null) old = [];
            var newData = old.concat(array);
            localStorage.setItem("apps", JSON.stringify(newData));
            getApps();
        }

        function getApps() {
            $("#current").empty();
            var localapps = JSON.parse(localStorage.getItem("apps"));
            if (localapps && localapps.length > 0) {
                localapps.forEach(app => {
                    var name = app.trackName;
                    console.log(app);
                    var obj = '<li><img class="icon" src="' + fixURL(app.artworkUrl100) +
                        '"><button class="small" onclick="removeApp(' + app.trackId +
                        ');">-</button>' + name +
                        '</li>'
                    $("#current").append(obj)
                });
            }
            exportList();
        }

        function clearList() {
            localStorage.removeItem("apps");
            getApps();
        }

        getApps();
        getTopApps();



        var freeApps;
        var paidApps;

        function getTopApps() {
            getFreeApps();
            getPaidApps();


        }

        function getPaidApps() {
            var settings = {
                "async": true,
                "url": "/paid-apps",
                "method": "GET",
            }
            $.ajax(settings).done(function (response) {
                console.log(response);

                paidApps = response.feed.results;

                setAppStore();
            });
        }

        function getFreeApps() {
            var settings = {
                "async": true,
                "url": "/free-apps",
                "method": "GET",
            }
            $.ajax(settings).done(function (response) {
                console.log(response);

                freeApps = response.feed.results;

                setAppStore();
            });
        }

        function setAppStore() {
            console.log("freeApps", freeApps);
            console.log("paidApps", paidApps);
            if (freeApps && paidApps) {
                console.log("combine");
                var arrayCombined = $.map(freeApps, function (v, i) {
                    return [v, paidApps[i]];
                });
                console.log(arrayCombined);
                setTopApps(arrayCombined);
            }
        }

        function setTopApps(array) {
            array.forEach(app => {
                var name = app.name;
                var obj = '<li><img class="icon" src="' + fixURL(app.artworkUrl100) +
                    '"><button class="small" onclick="getAppWithId(' + app.id +
                    ', \'US\');">+</button>' + name +
                    '</li>'
                $("#topapps").append(obj)
            });
        }

        function removeApp(id) {

            var old = JSON.parse(localStorage.getItem("apps"));
            if (old === null) old = [];

            console.log(old);
            console.log(id);

            old = old.filter(function (item) {
                console.log(item.trackID);
                return item.trackId !== id
            })

            console.log(old);

            localStorage.setItem("apps", JSON.stringify(old));
            getApps();
        }

        function fixURL(url) {
            if (url.indexOf("100x100bb") !== -1) {
                var newURL = url.replace('100x100bb', '200x200bb');
                return newURL
            } else {
                return url
            }
        }
    </script>
</body>

</html>
